{% extends "base.html" %}

{% block title %}My Wishlist - E-Commerce Store{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>My Wishlist</h1>
        <p>Save products you love for later purchase.</p>
    </div>

    <!-- Wishlist Items -->
    <div id="wishlist-container">
        <div class="loading">Loading your wishlist...</div>
    </div>

    <!-- Empty Wishlist Message -->
    <div id="empty-wishlist" class="empty-state" style="display: none;">
        <div class="empty-icon">üíù</div>
        <h2>Your wishlist is empty</h2>
        <p>Start adding products you love to your wishlist!</p>
        <a href="/web/products" class="btn btn-primary">Browse Products</a>
    </div>
</div>

<style>
.wishlist-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.wishlist-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    overflow: hidden;
    transition: all 0.3s ease;
    position: relative;
}

.wishlist-item:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.wishlist-item img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
}

.wishlist-item img:not([src]) {
    background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%), 
                linear-gradient(-45deg, #f8f9fa 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #f8f9fa 75%), 
                linear-gradient(-45deg, transparent 75%, #f8f9fa 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
}

.wishlist-item-content {
    padding: 1.5rem;
}

.wishlist-item h3 {
    margin: 0 0 0.5rem 0;
    color: #333;
    font-size: 1.1rem;
}

.wishlist-item .price {
    font-size: 1.2rem;
    font-weight: bold;
    color: #007bff;
    margin-bottom: 1rem;
}

.wishlist-item .description {
    color: #6c757d;
    font-size: 0.9rem;
    margin-bottom: 1rem;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

.wishlist-item-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.wishlist-item-actions .btn {
    flex: 1;
    padding: 0.5rem;
    font-size: 0.9rem;
}

.remove-wishlist-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: rgba(220, 53, 69, 0.9);
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.remove-wishlist-btn:hover {
    background: #dc3545;
}

.wishlist-item .stock-status {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.stock-status.in-stock {
    background: #d4edda;
    color: #155724;
}

.stock-status.low-stock {
    background: #fff3cd;
    color: #856404;
}

.stock-status.out-of-stock {
    background: #f8d7da;
    color: #721c24;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-top: 2rem;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.empty-state h2 {
    color: #333;
    margin-bottom: 1rem;
}

.empty-state p {
    color: #6c757d;
    margin-bottom: 2rem;
}

.loading {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
    font-size: 1.1rem;
}

@media (max-width: 768px) {
    .wishlist-container {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .wishlist-item-actions {
        flex-direction: column;
    }
}
</style>

<script>
let wishlistData = [];

// Load wishlist
async function loadWishlist() {
    if (!checkAuth()) return;

    try {
        const response = await fetch('/api/wishlist', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        const data = await response.json();

        if (data.success) {
            wishlistData = data.data;
            console.log('Wishlist API response:', data);
            displayWishlist(data.data);
        } else {
            showAlert('Failed to load wishlist', 'error');
        }
    } catch (error) {
        console.error('Error loading wishlist:', error);
        showAlert('Error loading wishlist', 'error');
    }
}

// Test image loading
function testImageLoad(url) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url;
    });
}

// Display wishlist
function displayWishlist(items) {
    const container = document.getElementById('wishlist-container');
    const emptyState = document.getElementById('empty-wishlist');

    if (items.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }

    container.style.display = 'grid';
    emptyState.style.display = 'none';

    // Debug: Log the items to see what data we're getting
    console.log('Wishlist items:', items);

    container.innerHTML = items.map(item => {
        // Debug: Log each item's product data
        console.log('Product data for item:', item.product);
        
        const imageUrl = item.product.image_url || '/static/img/placeholder.svg';
        
        return `
        <div class="wishlist-item" data-product-id="${item.product.id}">
            <button class="remove-wishlist-btn" onclick="removeFromWishlist(${item.id})" title="Remove from wishlist">
                √ó
            </button>
            <img src="${imageUrl}" 
                 alt="${item.product.name}" 
                 onerror="this.src='/static/img/placeholder.svg'; this.onerror=null;"
                 loading="lazy"
                 onload="console.log('Image loaded successfully:', this.src)"
                 onerror="console.log('Image failed to load:', this.src)">
            <div class="wishlist-item-content">
                <h3>${item.product.name}</h3>
                <div class="price">$${item.product.price.toFixed(2)}</div>
                <div class="description">${item.product.description}</div>
                <div class="stock-status ${getStockStatus(item.product.stock)}">${getStockText(item.product.stock)}</div>
                <div class="wishlist-item-actions">
                    <button class="btn btn-primary" onclick="addToCart(${item.product.id})">
                        Add to Cart
                    </button>
                    <button class="btn btn-outline" onclick="viewProduct(${item.product.id})">
                        View Details
                    </button>
                </div>
            </div>
        </div>
        `;
    }).join('');
}

// Get stock status class
function getStockStatus(stock) {
    if (stock === 0) return 'out-of-stock';
    if (stock < 10) return 'low-stock';
    return 'in-stock';
}

// Get stock text
function getStockText(stock) {
    if (stock === 0) return 'Out of Stock';
    if (stock < 10) return `Only ${stock} left`;
    return 'In Stock';
}

// Remove from wishlist
async function removeFromWishlist(itemId) {
    if (!confirm('Remove this item from your wishlist?')) return;

    try {
        const response = await fetch(`/api/wishlist/${itemId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Item removed from wishlist', 'success');
            loadWishlist(); // Reload wishlist
        } else {
            showAlert('Failed to remove item from wishlist', 'error');
        }
    } catch (error) {
        console.error('Error removing from wishlist:', error);
        showAlert('Error removing item from wishlist', 'error');
    }
}

// Add to cart
async function addToCart(productId) {
    try {
        const response = await fetch('/api/cart/items', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                product_id: productId,
                quantity: 1
            })
        });

        const data = await response.json();

        if (data.success) {
            showAlert('Item added to cart', 'success');
            updateCartCount();
        } else {
            showAlert(data.error || 'Failed to add item to cart', 'error');
        }
    } catch (error) {
        console.error('Error adding to cart:', error);
        showAlert('Error adding item to cart', 'error');
    }
}

// View product details
function viewProduct(productId) {
    window.location.href = `/web/products/${productId}`;
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadWishlist();
});
</script>
{% endblock %}
