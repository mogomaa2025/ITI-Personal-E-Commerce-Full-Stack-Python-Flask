{% extends "base.html" %}

{% block title %}Notifications - E-Commerce Store{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Notifications</h1>
        <p>Stay updated with your account activities and promotions.</p>
    </div>

    <!-- Notification Controls -->
    <div class="notification-controls">
        <button id="mark-all-read-btn" class="btn btn-primary">Mark All as Read</button>
        <button id="refresh-notifications-btn" class="btn btn-outline">Refresh</button>
    </div>

    <!-- Notifications List -->
    <div id="notifications-container">
        <div class="loading">Loading notifications...</div>
    </div>

    <!-- Empty Notifications Message -->
    <div id="empty-notifications" class="empty-state" style="display: none;">
        <div class="empty-icon">ðŸ””</div>
        <h2>No notifications yet</h2>
        <p>We'll notify you about important updates, promotions, and account activities.</p>
    </div>
</div>

<style>
.notification-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.notifications-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.notification-item {
    background: white;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 1.5rem;
    transition: all 0.3s ease;
    position: relative;
}

.notification-item:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.notification-item.unread {
    border-left: 4px solid #007bff;
    background: #f8f9ff;
}

.notification-item.read {
    opacity: 0.7;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.notification-title {
    font-weight: 600;
    color: #333;
    margin: 0;
}

.notification-time {
    color: #6c757d;
    font-size: 0.9rem;
}

.notification-content {
    color: #555;
    margin-bottom: 1rem;
    line-height: 1.5;
}

.notification-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

.notification-actions .btn {
    padding: 0.25rem 0.75rem;
    font-size: 0.9rem;
}

.notification-type {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.notification-type.info {
    background: #d1ecf1;
    color: #0c5460;
}

.notification-type.success {
    background: #d4edda;
    color: #155724;
}

.notification-type.warning {
    background: #fff3cd;
    color: #856404;
}

.notification-type.error {
    background: #f8d7da;
    color: #721c24;
}

.notification-type.promotion {
    background: #e2e3e5;
    color: #383d41;
}

.read-status {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 8px;
    height: 8px;
    background: #007bff;
    border-radius: 50%;
}

.read-status.read {
    background: transparent;
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-top: 2rem;
}

.empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.empty-state h2 {
    color: #333;
    margin-bottom: 1rem;
}

.empty-state p {
    color: #6c757d;
}

.loading {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
    font-size: 1.1rem;
}

@media (max-width: 768px) {
    .notification-controls {
        flex-direction: column;
    }
    
    .notification-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .notification-actions {
        flex-direction: column;
    }
}
</style>

<script>
let notificationsData = [];

// Load notifications
async function loadNotifications() {
    if (!checkAuth()) return;

    try {
        const response = await fetch('/api/notifications', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        const data = await response.json();

        if (data.success) {
            notificationsData = data.data;
            displayNotifications(data.data);
            updateNotificationCount(data.data);
        } else {
            showAlert('Failed to load notifications', 'error');
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
        showAlert('Error loading notifications', 'error');
    }
}

// Display notifications
function displayNotifications(notifications) {
    const container = document.getElementById('notifications-container');
    const emptyState = document.getElementById('empty-notifications');

    if (notifications.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }

    container.style.display = 'block';
    emptyState.style.display = 'none';

    // Sort notifications by date (newest first)
    notifications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

    container.innerHTML = notifications.map(notification => `
        <div class="notification-item ${notification.is_read ? 'read' : 'unread'}" data-id="${notification.id}">
            <div class="read-status ${notification.is_read ? 'read' : ''}"></div>
            <div class="notification-header">
                <h3 class="notification-title">${notification.title}</h3>
                <span class="notification-time">${formatDate(notification.created_at)}</span>
            </div>
            <div class="notification-type ${notification.type || 'info'}">${getTypeLabel(notification.type)}</div>
            <div class="notification-content">${notification.message}</div>
            ${!notification.is_read ? `
                <div class="notification-actions">
                    <button class="btn btn-primary" onclick="markAsRead(${notification.id})">
                        Mark as Read
                    </button>
                </div>
            ` : ''}
        </div>
    `).join('');
}

// Format date for display
function formatDate(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffHours < 24) return `${diffHours}h ago`;
    if (diffDays < 7) return `${diffDays}d ago`;
    
    return date.toLocaleDateString();
}

// Get type label
function getTypeLabel(type) {
    const labels = {
        'info': 'Information',
        'success': 'Success',
        'warning': 'Warning',
        'error': 'Error',
        'promotion': 'Promotion'
    };
    return labels[type] || 'Notification';
}

// Mark notification as read
async function markAsRead(notificationId) {
    try {
        const response = await fetch(`/api/notifications/${notificationId}/read`, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        const data = await response.json();

        if (data.success) {
            // Update the notification in the UI
            const notificationElement = document.querySelector(`[data-id="${notificationId}"]`);
            if (notificationElement) {
                notificationElement.classList.remove('unread');
                notificationElement.classList.add('read');
                notificationElement.querySelector('.read-status').classList.add('read');
                notificationElement.querySelector('.notification-actions').remove();
            }
            
            // Update the data
            const notification = notificationsData.find(n => n.id === notificationId);
            if (notification) {
                notification.is_read = true;
                notification.read_at = new Date().toISOString();
            }
            
            updateNotificationCount(notificationsData);
            showAlert('Notification marked as read', 'success');
        } else {
            showAlert('Failed to mark notification as read', 'error');
        }
    } catch (error) {
        console.error('Error marking notification as read:', error);
        showAlert('Error marking notification as read', 'error');
    }
}

// Mark all notifications as read
async function markAllAsRead() {
    try {
        const response = await fetch('/api/notifications/read-all', {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });

        const data = await response.json();

        if (data.success) {
            showAlert(data.message, 'success');
            loadNotifications(); // Reload notifications
        } else {
            showAlert('Failed to mark all notifications as read', 'error');
        }
    } catch (error) {
        console.error('Error marking all notifications as read:', error);
        showAlert('Error marking all notifications as read', 'error');
    }
}

// Update notification count in navigation
function updateNotificationCount(notifications) {
    const unreadCount = notifications.filter(n => !n.is_read).length;
    const countElement = document.getElementById('notification-count');
    if (countElement) {
        countElement.textContent = unreadCount;
        countElement.style.display = unreadCount > 0 ? 'inline' : 'none';
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadNotifications();

    // Event listeners
    document.getElementById('mark-all-read-btn').addEventListener('click', markAllAsRead);
    document.getElementById('refresh-notifications-btn').addEventListener('click', loadNotifications);
});
</script>
{% endblock %}
