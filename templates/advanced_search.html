{% extends "base.html" %}

{% block title %}Advanced Search - E-Commerce Store{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1>Advanced Search</h1>
        <p>Find exactly what you're looking for with our powerful search filters.</p>
    </div>

    <!-- Search Filters -->
    <div class="search-filters">
        <form id="advanced-search-form">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="search-query">Search Term</label>
                    <input type="text" id="search-query" name="q" placeholder="Enter keywords..." class="form-input">
                </div>

                <div class="filter-group">
                    <label for="category-filter">Category</label>
                    <select id="category-filter" name="category" class="form-select">
                        <option value="">All Categories</option>
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label for="min-price">Minimum Price</label>
                    <input type="number" id="min-price" name="min_price" placeholder="0.00" step="0.01"
                        class="form-input">
                </div>

                <div class="filter-group">
                    <label for="max-price">Maximum Price</label>
                    <input type="number" id="max-price" name="max_price" placeholder="1000.00" step="0.01"
                        class="form-input">
                </div>

                <div class="filter-group">
                    <label for="min-rating">Minimum Rating</label>
                    <select id="min-rating" name="min_rating" class="form-select">
                        <option value="">Any Rating</option>
                        <option value="1">1+ Stars</option>
                        <option value="2">2+ Stars</option>
                        <option value="3">3+ Stars</option>
                        <option value="4">4+ Stars</option>
                        <option value="5">5 Stars</option>
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="filter-group">
                    <label for="sort-by">Sort By</label>
                    <select id="sort-by" name="sort_by" class="form-select">
                        <option value="name">Name</option>
                        <option value="price">Price</option>
                        <option value="rating">Rating</option>
                        <option value="created_at">Date Added</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="sort-order">Sort Order</label>
                    <select id="sort-order" name="sort_order" class="form-select">
                        <option value="asc">Ascending</option>
                        <option value="desc">Descending</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label>&nbsp;</label>
                    <div class="filter-actions">
                        <button type="submit" class="btn btn-primary">Search</button>
                        <button type="button" id="clear-filters-btn" class="btn btn-outline">Clear</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Search Results -->
    <div class="search-results">
        <div id="search-results-header" style="display: none;">
            <h2>Search Results</h2>
            <div id="results-count"></div>
        </div>

        <div id="search-results-container">
            <div class="search-prompt">
                <div class="search-icon">üîç</div>
                <h3>Start your search</h3>
                <p>Use the filters above to find the perfect products for you.</p>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="search-loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>Searching products...</p>
    </div>

    <!-- No Results -->
    <div id="no-results" class="no-results" style="display: none;">
        <div class="no-results-icon">üòû</div>
        <h3>No products found</h3>
        <p>Try adjusting your search criteria or browse our <a href="/web/products">full catalog</a>.</p>
    </div>
</div>

<style>
    .search-filters {
        background: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-group label {
        font-weight: 600;
        color: #333;
    }

    .form-input,
    .form-select {
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }

    .form-input:focus,
    .form-select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    .filter-actions {
        display: flex;
        gap: 0.5rem;
        align-items: flex-end;
    }

    .search-results {
        min-height: 400px;
    }

    .search-results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .search-results-header h2 {
        margin: 0;
        color: #333;
    }

    .results-count {
        color: #6c757d;
        font-size: 1rem;
    }

    .search-prompt {
        text-align: center;
        padding: 4rem 2rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 2rem;
    }

    .search-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .search-prompt h3 {
        color: #333;
        margin-bottom: 1rem;
    }

    .search-prompt p {
        color: #6c757d;
    }

    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 2rem;
        margin-top: 2rem;
    }

    .product-card {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .product-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .product-card img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }

    .product-card-content {
        padding: 1.5rem;
    }

    .product-card h3 {
        margin: 0 0 0.5rem 0;
        color: #333;
        font-size: 1.1rem;
    }

    .product-card .price {
        font-size: 1.2rem;
        font-weight: bold;
        color: #007bff;
        margin-bottom: 0.5rem;
    }

    .product-card .rating {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .product-card .stars {
        color: #ffc107;
    }

    .product-card .rating-text {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .product-card .description {
        color: #6c757d;
        font-size: 0.9rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-bottom: 1rem;
    }

    .product-card .actions {
        display: flex;
        gap: 0.5rem;
    }

    .product-card .btn {
        flex: 1;
        padding: 0.5rem;
        font-size: 0.9rem;
    }

    .loading {
        text-align: center;
        padding: 3rem;
        color: #6c757d;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    .no-results {
        text-align: center;
        padding: 4rem 2rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 2rem;
    }

    .no-results-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .no-results h3 {
        color: #333;
        margin-bottom: 1rem;
    }

    .no-results p {
        color: #6c757d;
    }

    .no-results a {
        color: #007bff;
        text-decoration: none;
    }

    .no-results a:hover {
        text-decoration: underline;
    }

    @media (max-width: 768px) {
        .filter-row {
            grid-template-columns: 1fr;
        }

        .filter-actions {
            flex-direction: column;
        }

        .products-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    let currentSearchData = [];

    // Load categories
    async function loadCategories() {
        try {
            const response = await fetch('/api/categories');
            const data = await response.json();

            if (data.success) {
                const select = document.getElementById('category-filter');
                select.innerHTML = '<option value="">All Categories</option>' +
                    data.data.map(category => `<option value="${category.name}">${category.name}</option>`).join('');
            }
        } catch (error) {
            console.error('Error loading categories:', error);
        }
    }

    // Perform advanced search
    async function performSearch(searchParams) {
        try {
            showLoading(true);

            const params = new URLSearchParams();
            Object.keys(searchParams).forEach(key => {
                if (searchParams[key]) {
                    params.append(key, searchParams[key]);
                }
            });

            const response = await fetch(`/api/search/advanced?${params.toString()}`);
            const data = await response.json();

            if (data.success) {
                currentSearchData = data.data;
                displaySearchResults(data.data, data.count);
            } else {
                showAlert('Search failed', 'error');
            }
        } catch (error) {
            console.error('Error performing search:', error);
            showAlert('Error performing search', 'error');
        } finally {
            showLoading(false);
        }
    }

    // Display search results
    function displaySearchResults(products, count) {
        const header = document.getElementById('search-results-header');
        const container = document.getElementById('search-results-container');
        const noResults = document.getElementById('no-results');

        if (products.length === 0) {
            header.style.display = 'none';
            container.style.display = 'none';
            noResults.style.display = 'block';
            return;
        }

        header.style.display = 'block';
        container.style.display = 'block';
        noResults.style.display = 'none';

        document.getElementById('results-count').textContent = `${count} product${count !== 1 ? 's' : ''} found`;

        container.innerHTML = `
        <div class="products-grid">
            ${products.map(product => `
                <div class="product-card" onclick="viewProduct(${product.id})">
                    <img src="${product.image_url}" alt="${product.name}" onerror="this.src='/static/img/placeholder.svg'">
                    <div class="product-card-content">
                        <h3>${product.name}</h3>
                        <div class="price">$${product.price.toFixed(2)}</div>
                        <div class="rating">
                            <span class="stars">${'‚òÖ'.repeat(Math.floor(product.average_rating || 0))}${'‚òÜ'.repeat(5 - Math.floor(product.average_rating || 0))}</span>
                            <span class="rating-text">(${product.average_rating ? product.average_rating.toFixed(1) : 'No rating'})</span>
                        </div>
                        <div class="description">${product.description}</div>
                        <div class="actions">
                            <button class="btn btn-primary" onclick="event.stopPropagation(); addToCart(${product.id})">
                                Add to Cart
                            </button>
                            <button class="btn btn-outline" onclick="event.stopPropagation(); viewProduct(${product.id})">
                                View Details
                            </button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    }

    // Show/hide loading state
    function showLoading(show) {
        const loading = document.getElementById('search-loading');
        const container = document.getElementById('search-results-container');

        if (show) {
            loading.style.display = 'block';
            container.style.display = 'none';
        } else {
            loading.style.display = 'none';
            container.style.display = 'block';
        }
    }

    // Add to cart
    async function addToCart(productId) {
        if (!checkAuth()) return;

        try {
            const response = await fetch('/api/cart/items', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: 1
                })
            });

            const data = await response.json();

            if (data.success) {
                showAlert('Item added to cart', 'success');
                updateCartCount();
            } else {
                showAlert(data.error || 'Failed to add item to cart', 'error');
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            showAlert('Error adding item to cart', 'error');
        }
    }

    // View product details
    function viewProduct(productId) {
        window.location.href = `/web/products/${productId}`;
    }

    // Clear all filters
    function clearFilters() {
        document.getElementById('advanced-search-form').reset();
        document.getElementById('search-results-header').style.display = 'none';
        document.getElementById('search-results-container').innerHTML = `
        <div class="search-prompt">
            <div class="search-icon">üîç</div>
            <h3>Start your search</h3>
            <p>Use the filters above to find the perfect products for you.</p>
        </div>
    `;
        document.getElementById('no-results').style.display = 'none';
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', function () {
        loadCategories();

        // Form submission
        document.getElementById('advanced-search-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const searchParams = {};

            for (let [key, value] of formData.entries()) {
                if (value.trim()) {
                    searchParams[key] = value.trim();
                }
            }

            performSearch(searchParams);
        });

        // Clear filters button
        document.getElementById('clear-filters-btn').addEventListener('click', clearFilters);
    });
</script>
{% endblock %}